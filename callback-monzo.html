<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Monzo Callback - MyDough</title>
	<meta name="author" content="Benjamin Howe" />
  <script type="text/javascript" src="cookies.js" ></script>
	<script type="text/javascript">
    window.params = function() {
      var params = {};
      var paramArray = window.location.href.split("?")[1].split("&");
      for(var i in paramArray){
        x = paramArray[i].split("=");
        params[x[0]] = x[1];
      }
      return params;
    }();
    
    if (!getCookie("monzoAuthInProgress")) {
      throw new Error("Couldn't get monzoAuthInProgress cookie!");
    }
    var monzoAuthInProgress = JSON.parse(getCookie("monzoAuthInProgress"));
    
    if (window.params.state != monzoAuthInProgress.state) {
      throw new Error("Invalid state!");
    }
    
    if (getCookie("auths")) {
      auths = JSON.parse(getCookie("auths"));
    } else {
      auths = new Array();
    }
    
    var request = new XMLHttpRequest();
    request.open("POST", "https://api.monzo.com/oauth2/token", false);
    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    request.send("grant_type=authorization_code&client_id=" + monzoAuthInProgress.client_id + "&client_secret=" + monzoAuthInProgress.client_secret + "&redirect_uri=" + monzoAuthInProgress.redirect_uri + "&code=" + window.params.code);
    
    if (request.status == 200) {
      auths.push({
        "name": "Monzo account",
        "type": "monzo",
        "access_token": JSON.parse(request.responseText).access_token,
        "access_expires": Date.now() + JSON.parse(request.responseText).expires_in * 1000,
      })
      
      var cookiePath = new RegExp("https://.+?(/.+?)/callback-monzo.html").exec(document.location.href)[1];
      //setCookie("monzoAuthInProgress", "", cookiePath, -1); // expire the "in progress" cookie
      setCookie("auths", JSON.stringify(auths), cookiePath, 48);
    }
  </script>
  <script type="text/javascript" src="cookies.js" ></script>
</head>
<body>
</body>
</html>