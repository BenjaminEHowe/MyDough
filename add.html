<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Add Account - MyDough</title>
	<meta name="author" content="Benjamin Howe" />
	<link rel="stylesheet" href="mydough.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
  <script type="text/javascript">
    function changeProvider() {
      var provider = document.getElementById("provider").value;
      var providerDetails = document.getElementById("providerDetails");
      if (provider == '') {
        providerDetails.innerHTML = '';
      } else if (provider == 'monzo') {
        providerDetails.innerHTML += 'You need to <a href="https://developers.monzo.com/apps/">create an oAuth client</a>.<br />';
        providerDetails.innerHTML += '<label for="client_id">Client ID:</label><input id="client_id" type="text"><br />';
        providerDetails.innerHTML += '<label for="client_secret">Client Secret:</label><input id="client_secret" type="text"><br />';
        providerDetails.innerHTML += '<button id="submitDetails" type="button">Submit</button>';
        document.getElementById("submitDetails").addEventListener("click", submitDetails);
      }
    }
    
    function submitDetails() {
      var provider = document.getElementById("provider").value;
      if (provider == 'monzo') {
        // set client ID, secret, redirect uri, and state
        var monzoAuthInProgress = {
          "client_id": document.getElementById("client_id").value,
          "client_secret": document.getElementById("client_secret").value,
          "redirect_uri": window.location.href.replace("add.html", "") + "callback-monzo.html",
          "state": Math.random().toString(36),
        }
        // save everything in a cookie for later
        var cookiePath = new RegExp("https://.+?(/.+?)/add.html").exec(document.location.href)[1];
        setCookie("monzoAuthInProgress", JSON.stringify(monzoAuthInProgress), cookiePath);
        // redirect to monzo
        window.location = "https://auth.getmondo.co.uk/?client_id=" + monzoAuthInProgress.client_id + "&redirect_uri=" + monzoAuthInProgress.redirect_uri + "&response_type=code&state=" + monzoAuthInProgress.state;
      }
    }
    
    window.onload = function(e) {
      document.getElementById("provider").addEventListener("change", changeProvider, false);
    };
  </script>
  <script type="text/javascript" src="cookies.js" ></script>
</head>
<body>
  <nav class="navbar navbar-mydough navbar-fixed-top">
    <div class="container">
      <div class="navbar-header"><a class="navbar-brand" href="/">MyDough <sup>beta</sup></a></div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="index.html">Home</a></li>
          <li class="active"><a href="add.html">Add<span class="sr-only"> (current)</span></a></li>
		      <li><a href="about.html">About</a></li>
		      <li><a href="help.html">Help</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="col-md-12">
      <label for="provider">Account provider:</label>
      <select id="provider">
        <option value="">---</option>
        <option value="monzo">Monzo</option>
      </select>
      <div id="providerDetails"></div>
    </div>
  </div>
</body>
</html>